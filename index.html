<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과세특 리포트 생성기</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            body {
                background: white;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-after: always;
                break-after: page;
            }
            .report-page {
                box-shadow: none !important;
                margin: 0 !important;
                width: 210mm !important;
                height: 297mm !important;
                overflow: hidden;
            }
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
        }

        /* Hero Header Styling */
        .hero-header {
            background: linear-gradient(135deg, #002B66 0%, #1e3a8a 50%, #0369a1 100%);
            padding: 100px 20px 160px;
            position: relative;
            overflow: hidden;
            color: white;
            text-align: center;
        }

        .hero-shapes .shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: 1;
        }
        .shape-1 { width: 400px; height: 400px; background: #3b82f6; top: -100px; left: -100px; }
        .shape-2 { width: 350px; height: 350px; background: #06b6d4; bottom: -50px; right: -50px; }

        .header-content { position: relative; z-index: 10; }

        .logo-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .pro-badge {
            background: #eab308;
            color: #451a03;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.4);
        }

        .shadow-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }

        /* Glass Card Control Panel */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            margin: -100px auto 48px;
            padding: 40px;
            max-width: 1200px;
            position: relative;
            z-index: 20;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modern-input-group { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .modern-input-group label { font-size: 13px; font-weight: 700; color: #64748b; margin-left: 4px; }
        .modern-input {
            background-color: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .modern-input:focus {
            background-color: white;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .primary-btn {
            background: #2563eb;
            color: white;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .primary-btn:hover { background: #1d4ed8; transform: translateY(-1px); }
        .primary-btn:active { transform: translateY(0); }

        .secondary-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .secondary-btn:hover { border-color: #3b82f6; background: #f8fafc; }

        /* Report Page Styling */
        .report-page {
            width: 210mm;
            min-height: 297mm;
            padding: 18mm;
            margin: 40px auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .font-noto { font-family: 'Noto Sans KR', sans-serif; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Hero Header -->
    <header class="hero-header no-print">
        <div class="hero-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
        </div>
        <div class="header-content">
            <div class="logo-area">
                <div class="bg-blue-500 p-1.5 rounded-lg shadow-glow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25Options.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z" />
                    </svg>
                </div>
                <span class="font-bold text-sm tracking-tight uppercase">AI Report Studio</span>
                <span class="pro-badge">Premium</span>
            </div>
            <h2 class="text-5xl xl:text-6xl font-black mb-4 tracking-tight">과세특 리포트 생성기</h2>
            <p class="text-blue-100 max-w-xl mx-auto font-medium opacity-90">나이스 엑셀 파일을 업로드하여 품격 있는 개인별 리포트를 즉시 생성하세요.</p>
        </div>
    </header>

    <!-- Control Panel Glass Card -->
    <div class="no-print glass-card">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-start">
            <div class="modern-input-group">
                <label>학교 명칭</label>
                <input type="text" id="schoolNameInput" class="modern-input" placeholder="예: 원묵고등학교">
            </div>
            <div class="modern-input-group">
                <label>담당 교사</label>
                <input type="text" id="teacherNameInput" class="modern-input" placeholder="성함을 입력하세요">
            </div>
            <div class="flex flex-col gap-2">
                <div class="flex gap-2 h-[50px]">
                    <label id="logoLabelBtn" class="flex-1 secondary-btn cursor-pointer text-sm font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span>학교 로고</span>
                        <input type="file" id="logoInput" accept="image/*" class="hidden" />
                    </label>
                    <label id="fileLabelBtn" class="flex-1 primary-btn cursor-pointer text-sm font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span id="fileLabelText">나이스 파일</span>
                        <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" multiple class="hidden" />
                    </label>
                </div>
                <div id="statusArea" class="flex flex-col gap-1 px-1 min-h-[1.5rem]"></div>
            </div>
            <button onclick="window.print()" id="printBtn" disabled class="primary-btn w-full h-[50px] !bg-slate-900 hover:!bg-black disabled:opacity-30 disabled:grayscale transition-all active:scale-95 font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                <span>결과물 인쇄하기</span>
            </button>
        </div>
    </div>

    <!-- Container for Generated Reports -->
    <div id="reportContainer" class="pb-20">
        <div id="emptyPlaceholder" class="no-print py-32 text-center bg-white rounded-[2rem] shadow-sm border border-slate-200 max-w-2xl mx-auto px-10">
            <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-8 text-blue-500 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-4 tracking-tight">리포트를 생성할 준비가 되었습니다</h3>
            <p class="text-slate-500 leading-relaxed font-medium">나이스에서 다운로드한 과세특 엑셀 파일들을 선택해주세요.<br>여러 과목을 한 번에 선택하면 학생별로 자동 병합됩니다.</p>
        </div>
    </div>

    <script>
        // Sort order and subject map logic from React code
        const subjectOrder = [
            "영어Ⅰ", "영어I", "영어Ⅱ", "영어II", "영미 문학 읽기", "영미문학읽기", "영어권 문화", "영어권문화"
        ];
        const subjectMap = {
            "영어Ⅰ": 1, "영어I": 1, "영어Ⅱ": 2, "영어II": 2,
            "영미 문학 읽기": 3, "영미문학읽기": 3, "영어권 문화": 4, "영어권문화": 4
        };
        const page1Subjects = ["영어Ⅰ", "영어I", "영어Ⅱ", "영어II"];
        const page2Subjects = ["영미 문학 읽기", "영미문학읽기", "영어권 문화", "영어권문화"];

        let uploadedLogoData = null; 
        let uploadedLogoName = null;
        let uploadedStudentData = null; 

        // Update UI on input
        document.getElementById('schoolNameInput').addEventListener('input', () => uploadedStudentData && renderReports(uploadedStudentData));
        document.getElementById('teacherNameInput').addEventListener('input', () => uploadedStudentData && renderReports(uploadedStudentData));

        // Logo Upload
        document.getElementById('logoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            uploadedLogoName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedLogoData = e.target.result;
                updateStatusArea();
                if (uploadedStudentData) renderReports(uploadedStudentData);
            };
            reader.readAsDataURL(file);
        });

        // File Upload
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            document.getElementById('fileLabelText').textContent = `${files.length}개 완료`;
            let allRawData = [];
            
            for (const file of files) {
                const rows = await new Promise((resolve) => {
                    const reader = new FileReader();
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        reader.onload = (e) => resolve(XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).SheetNames[0]], {header: 1}));
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.onload = (e) => resolve(parseCSV(e.target.result));
                        reader.readAsText(file, 'UTF-8');
                    }
                });
                allRawData = allRawData.concat(normalizeData(rows));
            }

            uploadedStudentData = groupData(allRawData);
            updateStatusArea();
            renderReports(uploadedStudentData);
        });

        function updateStatusArea() {
            const area = document.getElementById('statusArea');
            area.innerHTML = '';
            if (uploadedLogoName) {
                area.innerHTML += `<div class="text-[10px] text-emerald-600 font-bold flex items-center gap-1 animate-fade-in"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>${uploadedLogoName}</div>`;
                document.getElementById('logoLabelBtn').classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700', 'ring-1', 'ring-emerald-200');
            }
            if (uploadedStudentData) {
                area.innerHTML += `<div class="text-[10px] text-blue-600 font-bold flex items-center gap-1 animate-fade-in"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>${uploadedStudentData.length}명의 데이터 분석 완료</div>`;
                document.getElementById('printBtn').disabled = false;
            }
        }

        function calculateBytes(str) {
            if (!str) return 0;
            let bytes = 0;
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i);
                if (code > 127) bytes += 3; else bytes += 1;
            }
            return bytes;
        }

        function generateId(grade, classNumStr) {
            const numbers = String(classNumStr).match(/\d+/g);
            if (!grade || !numbers || numbers.length < 2) return "";
            return parseInt(grade) * 10000 + parseInt(numbers[0]) * 100 + parseInt(numbers[1]);
        }

        function parseCSV(text) {
            const rows = []; let currentRow = [], currentCell = '', inQuotes = false;
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            for (let i = 0; i < text.length; i++) {
                const char = text[i], nextChar = text[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentCell += '"'; i++; }
                    else if (char === '"') inQuotes = false;
                    else currentCell += char;
                } else {
                    if (char === '"') inQuotes = true;
                    else if (char === ',') { currentRow.push(currentCell.trim()); currentCell = ''; }
                    else if (char === '\n' || char === '\r') {
                        if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
                        currentRow = []; currentCell = ''; if (char === '\r' && nextChar === '\n') i++;
                    } else currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
            return rows;
        }

        function normalizeData(rows) {
            if (!rows || rows.length < 2) return [];
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const rowStr = rows[i].join(" ");
                if (rowStr.includes("학년") && (rowStr.includes("반") || rowStr.includes("번호"))) { headerRowIndex = i; break; }
            }
            if (headerRowIndex === -1) return [];
            const header = rows[headerRowIndex].map(h => String(h).trim());
            const idxGrade = header.indexOf("학년"), idxSubject = header.indexOf("과목"), idxName = header.indexOf("성명");
            let idxClassNum = header.findIndex(h => h.includes("반/번호")) || header.findIndex(h => h === "반");
            const idxText = header.findIndex(h => h.includes("세부능력"));
            const fG = idxGrade > -1 ? idxGrade : 2, fS = idxSubject > -1 ? idxSubject : 4, fC = idxClassNum > -1 ? idxClassNum : 6, fN = idxName > -1 ? idxName : 7, fT = idxText > -1 ? idxText : 9;
            const normalized = [];
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[fN]) continue;
                const studentId = generateId(row[fG], row[fC]);
                if (studentId) normalized.push({ id: String(studentId), name: String(row[fN]).trim(), subject: String(row[fS]).trim(), text: row[fT] || "", bytes: calculateBytes(row[fT]) });
            }
            return normalized;
        }

        function groupData(data) {
            const groups = {};
            data.forEach(item => {
                const key = `${item.id}_${item.name}`;
                if (!groups[key]) groups[key] = { id: item.id, name: item.name, records: [] };
                if (!groups[key].records.find(r => r.subject === item.subject)) groups[key].records.push(item);
            });
            return Object.values(groups).sort((a, b) => parseInt(a.id) - parseInt(b.id));
        }

        function renderReports(students) {
            const container = document.getElementById('reportContainer');
            const placeholder = document.getElementById('emptyPlaceholder');
            if (placeholder) placeholder.remove();
            container.innerHTML = '';
            
            const teacherName = document.getElementById('teacherNameInput').value || "지도교사";
            const schoolNameInput = document.getElementById('schoolNameInput').value || "";
            const schoolNameDisplay = schoolNameInput || "학교명 미입력";
            const baseName = schoolNameInput.replace(/(고등학교|중학교|초등학교|학교|고)$/, "");
            const identityLabel = baseName ? `${baseName}인` : "인재";
            
            students.forEach((student) => {
                const p1 = student.records.filter(r => page1Subjects.includes(r.subject));
                const p2 = student.records.filter(r => page2Subjects.includes(r.subject));
                const others = student.records.filter(r => !page1Subjects.includes(r.subject) && !page2Subjects.includes(r.subject));
                
                const pages = [];
                if (p1.length > 0) pages.push(p1);
                if (p2.length > 0) pages.push(p2);
                for (let i = 0; i < others.length; i += 2) pages.push(others.slice(i, i + 2));
                
                pages.forEach((pageRecords) => {
                    const page = document.createElement('div');
                    page.className = 'report-page page-break';
                    const dateStr = `${new Date().getFullYear()}. ${String(new Date().getMonth() + 1).padStart(2, '0')}. ${String(new Date().getDate()).padStart(2, '0')}`;
                    
                    let subjectsHtml = '';
                    pageRecords.forEach((rec) => {
                        const styleMap = { "영어Ⅰ": "#1e3a8a", "영어I": "#1e3a8a", "영어Ⅱ": "#0f766e", "영어II": "#0f766e", "영미 문학 읽기": "#be123c", "영미문학읽기": "#be123c", "영어권 문화": "#d97706", "영어권문화": "#d97706" };
                        const borderColor = styleMap[rec.subject] || "#94a3b8";
                        
                        // Trim the text to remove leading/trailing spaces from the source Excel
                        const cleanText = rec.text.trim();
                        
                        subjectsHtml += `
                            <div class="bg-white rounded-r-2xl border-l-[6px] pl-2 py-3 transition-all" style="border-left-color: ${borderColor}">
                                <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                                    <h3 class="text-[15pt] font-black text-slate-800 flex items-center gap-4 leading-none">
                                        <span class="w-3 h-3 rounded-full bg-blue-500 shadow-inner"></span>
                                        ${rec.subject}
                                    </h3>
                                    <span class="text-[8.5pt] text-slate-400 font-bold tracking-tight bg-slate-50 px-2 py-0.5 rounded">
                                        ${rec.bytes} Bytes
                                    </span>
                                </div>
                                <p class="font-noto text-[10.8pt] leading-[1.8] text-slate-700 text-justify break-keep whitespace-pre-wrap font-medium" style="text-indent: 1.2em;">${cleanText}</p>
                            </div>`;
                    });

                    const logoDisplay = uploadedLogoData ? `<img src="${uploadedLogoData}" class="h-10 w-auto object-contain mb-2" alt="Logo">` : `<div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-200 border-2 border-blue-100 mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011-1v5m-4 0h4" /></svg></div>`;

                    page.innerHTML = `
                        <header class="flex justify-between items-start border-b-4 border-[#002B66] pb-3 mb-8">
                            <div>
                                <h1 class="text-[26pt] font-black text-[#002B66] tracking-tighter mb-1 leading-none">교과 세부능력 및 특기사항</h1>
                                <p class="text-[#1d4ed8] font-bold text-[12pt]">Global Leader를 꿈꾸는 ${identityLabel}</p>
                            </div>
                            <div class="flex flex-col items-end">
                                ${logoDisplay}
                                <div class="text-[9.5pt] text-[#002B66] font-bold bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">담당교사 : ${teacherName}</div>
                            </div>
                        </header>
                        <div class="bg-gradient-to-r from-[#002B66] to-[#1e3a8a] text-white py-4 px-10 rounded-[1.25rem] shadow-sm mb-10 flex items-center">
                            <div class="mr-12 border-r border-white/20 pr-12">
                                <span class="text-blue-200 text-[8pt] block mb-1 uppercase tracking-widest font-bold">Student ID</span>
                                <span class="text-[18pt] font-black tabular-nums leading-tight">${student.id}</span>
                            </div>
                            <div>
                                <span class="text-blue-200 text-[8pt] block mb-1 uppercase tracking-widest font-bold">Student Name</span>
                                <span class="text-[18pt] font-black tracking-wide leading-tight">${student.name}</span>
                            </div>
                            <div class="ml-auto opacity-20">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow space-y-8">${subjectsHtml}</div>
                        <footer class="mt-auto pt-8 border-t border-slate-200 text-center">
                            <p class="text-[9.5pt] text-slate-400 font-bold tracking-tight">
                                본 리포트는 학생의 학업 성취 및 교과 활동 내용을 기반으로 작성되었습니다. | 발행일: ${dateStr} | ${schoolNameDisplay}
                            </p>
                        </footer>`;
                    container.appendChild(page);
                });
            });
        }
    </script>
</body>
</html>
